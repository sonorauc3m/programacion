<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sonora UC3M – Emisión en directo</title>

<style>
:root{
  --rojo:#be1622;
  --negro:#050307;
  --text:#fff;
}

/* === GLOBAL === */
body{
  margin:0;
  font-family: Helvetica, Arial, sans-serif;
  background:radial-gradient(circle at top,#be1622 0%,#3a0307 55%,#000 100%);
  color:#fff;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  overflow:hidden;
}

/* CONTENEDOR */
.wrap{
  width:90%;
  max-width:950px;
}

/* LOGO */
.logo{
  width:380px;
  max-width:70vw;
  margin:auto;
  margin-bottom:16px;
}

/* SUBTÍTULO */
.subtitulo{
  font-size:1.15rem;
  margin-bottom:35px;
  opacity:.9;
  font-weight:300;
}

/* TARJETA DIRECTO */
.card{
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.18);
  padding:28px 32px;
  border-radius:22px;
  backdrop-filter:blur(18px);
  margin-top:10px;
}

/* TEXTO */
.label{
  font-size:.75rem;
  letter-spacing:4.5px;
  font-weight:700;
  margin-bottom:8px;
  opacity:.9;
  text-transform:uppercase;
}
.item{
  font-size:1.9rem;
  font-weight:700;
  margin-bottom:20px;
}
.sub{
  font-size:1.25rem;
  opacity:.88;
}
.empty{opacity:.65;}

/* === QR === */
.qr-box{
  position:fixed;
  right:26px; bottom:26px;
  width:125px; height:125px;
  background:rgba(0,0,0,.55);
  border-radius:20px; padding:8px;
  box-shadow:0 12px 28px rgba(0,0,0,.6);
}
.qr-box img{
  width:100%; height:100%;
  border-radius:12px; display:block;
}

/* MÓVIL */
@media(max-width:820px){
  .logo{width:260px;}
  .subtitulo{font-size:1rem;margin-bottom:22px;}
  .item{font-size:1.45rem;}
  .sub{font-size:1.05rem;}
  .qr-box{width:95px;height:95px;right:15px;bottom:15px;}
}
</style>

</head>
<body>

<div class="wrap">

  <!-- LOGO -->
  <img src="sonora_2.1_blanco.png" class="logo">

  <!-- SUBTÍTULO -->
  <div class="subtitulo">Emisión en directo – Sonora UC3M</div>

  <!-- DIRECTO -->
  <div class="card" id="liveBox">
    <div class="label">Ahora</div>
    <div id="now" class="item empty">Cargando...</div>

    <div class="label" style="margin-top:15px;">Siguiente</div>
    <div id="next" class="sub empty">Cargando...</div>
  </div>

</div>

<!-- QR → Programación -->
<div class="qr-box">
  <a href="https://sonorauc3m.github.io/programacion/" target="_blank">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&color=FFFFFF&bgcolor=190306&data=https%3A%2F%2Fsonorauc3m.github.io%2Fprogramacion%2F">
  </a>
</div>

<script>
/* Google Sheet Live */
const SHEET_ID="1g9f3Ue9GtdaTbpxp3DCXncrNPhjnHPk0m9QTXdfSAxM";
const SHEET="Directo";

async function fetchSheet(){
  try{
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET}`;
    const raw=await fetch(url).then(r=>r.text());
    const json=JSON.parse(raw.substr(47).slice(0,-2));
    return json.table.rows.map(r=>(r.c||[]).map(c=>c?.v||""));
  }catch{return[];}
}

function parseTime(t){
  const m=t.match(/\d{1,2}:\d{2}/g); if(!m) return null;
  const[sh,sm]=m[0].split(":").map(Number);
  const[eh,em]=m[1]?m[1].split(":").map(Number):[sh,sm+59];
  return{ini:sh*60+sm,fin:eh*60+em,label:t};
}

async function update(){
  let rows=(await fetchSheet()).slice(1);
  let slots=rows.map(([d,h,p])=>{let t=parseTime(h||"");return(d&&p&&t)?{dia:d,prog:p,...t}:null;}).filter(Boolean);

  const now=new Date(),min=now.getHours()*60+now.getMinutes();
  const today=["","lunes","martes","miércoles","jueves","viernes","sábado","domingo"][now.getDay()];
  let daySlots=slots.filter(s=>s.dia.toLowerCase().includes(today));
  let list=daySlots.length?daySlots:slots;
  let nowSlot=null,nextSlot=null;

  for(let s of list){
    if(min>=s.ini&&min<s.fin) nowSlot=s;
    else if(min<s.ini &&(!nextSlot||s.ini<nextSlot.ini)) nextSlot=s;
  }

  nowSlot?(now.textContent=nowSlot.prog,now.classList.remove("empty"))
          :(now.textContent="No hay emisión en directo",now.classList.add("empty"));

  nextSlot?(next.textContent=`${nextSlot.label} · ${nextSlot.prog}`,next.classList.remove("empty"))
           :(next.textContent="Sin más programas",next.classList.add("empty"));
}

update();
setInterval(update,20000);
</script>

</body>
</html>
